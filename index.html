<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The AI Readiness Framework</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');

*{margin:0;padding:0;box-sizing:border-box;}

html,body{
  width:100%;height:100%;
  background:#f7f5f1;
  font-family:'Inter',sans-serif;
  color:#1a1a2e;
  overflow:hidden;
}

/* ── NAV ── */
.top-nav{
  position:fixed;top:0;left:0;right:0;height:52px;
  background:rgba(247,245,241,0.96);
  backdrop-filter:blur(12px);
  border-bottom:1px solid #e0d8cc;
  display:flex;align-items:center;padding:0 20px;
  z-index:1000;gap:8px;
}
.nav-brand{font-size:13px;font-weight:800;color:#1C2D5E;letter-spacing:-.01em;margin-right:24px;white-space:nowrap;}
.nav-tabs{display:flex;gap:4px;}
.nav-tab{
  display:flex;align-items:center;gap:7px;
  padding:7px 14px;border-radius:6px;
  border:1px solid transparent;background:none;
  color:#8A9BB0;font-family:'Inter',sans-serif;
  font-size:11.5px;font-weight:600;letter-spacing:.02em;
  cursor:pointer;transition:all .2s;white-space:nowrap;
}
.nav-tab:hover{color:#1C2D5E;background:rgba(28,45,94,.05);}
.nav-tab.active{color:#1C2D5E;background:rgba(28,45,94,.08);border-color:rgba(28,45,94,.18);}
.nav-tab-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}

/* ── LAYOUT ── */
.view-container{position:absolute;top:52px;left:0;right:0;bottom:0;overflow:hidden;}
.view{position:absolute;inset:0;opacity:0;pointer-events:none;transition:opacity .3s ease;}
.view.active{opacity:1;pointer-events:all;}

/* ── OCTAGON VIEW ── */
#octagon-view{display:flex;overflow:hidden;}

/* LEFT SIDEBAR — themes */
.theme-sidebar{
  width:210px;flex-shrink:0;
  background:#fff;
  border-right:1px solid #e0d8cc;
  overflow-y:auto;
  padding:12px 0;
}
.sidebar-label{
  font-size:9px;font-weight:700;letter-spacing:.14em;
  text-transform:uppercase;color:#C8BC9E;
  padding:4px 16px 8px;
}
.sidebar-theme-btn{
  width:100%;padding:9px 16px;
  background:none;border:none;
  display:flex;align-items:center;gap:10px;
  cursor:pointer;transition:all .18s;
  border-left:3px solid transparent;
  text-align:left;
}
.sidebar-theme-btn:hover{background:rgba(28,45,94,.04);}
.sidebar-theme-btn.active{
  background:rgba(28,45,94,.06);
  border-left-color:#1C2D5E;
}
.sidebar-theme-btn.dep-needs{
  background:rgba(224,123,48,.08);
  border-left-color:#E07B30;
}
.sidebar-theme-btn.dep-enables{
  background:rgba(0,160,120,.08);
  border-left-color:#00A078;
}
.sidebar-theme-btn.dimmed{opacity:.25;}
.sidebar-num{
  font-size:9px;font-weight:700;color:#C8BC9E;
  font-family:monospace;min-width:18px;
}
.sidebar-name{font-size:11.5px;font-weight:600;color:#1C2D5E;line-height:1.3;}

/* OCTAGON CENTRE */
.octagon-centre{
  flex:1;display:flex;align-items:center;justify-content:center;
  position:relative;overflow:hidden;
}
.octagon-centre::before{
  content:'';position:absolute;inset:0;
  background-image:radial-gradient(circle,rgba(28,45,94,.04) 1px,transparent 1px);
  background-size:40px 40px;pointer-events:none;
}

/* RIGHT PANEL */
.dep-panel{
  width:230px;flex-shrink:0;
  background:#fff;border-left:1px solid #e0d8cc;
  padding:20px 16px;
  opacity:0;pointer-events:none;
  transition:opacity .25s;
  overflow-y:auto;
}
.dep-panel.visible{opacity:1;pointer-events:all;}
.dep-panel-title{font-size:13px;font-weight:800;color:#1C2D5E;margin-bottom:2px;line-height:1.3;}
.dep-panel-sub{font-size:9px;font-weight:600;letter-spacing:.12em;text-transform:uppercase;color:#C8BC9E;margin-bottom:18px;}
.dep-group{margin-bottom:18px;}
.dep-group-label{
  font-size:9px;font-weight:700;letter-spacing:.12em;
  text-transform:uppercase;margin-bottom:8px;
  display:flex;align-items:center;gap:6px;
}
.dep-group-label.needs{color:#E07B30;}
.dep-group-label.enables{color:#00A078;}
.dep-group-label::before{content:'';width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.dep-group-label.needs::before{background:#E07B30;}
.dep-group-label.enables::before{background:#00A078;}
.dep-item{
  display:flex;align-items:flex-start;gap:8px;
  padding:8px 10px;border-radius:6px;
  background:#f7f5f1;border:1px solid #e0d8cc;
  margin-bottom:5px;cursor:pointer;transition:all .15s;
}
.dep-item:hover{background:#f0ebe0;border-color:#C8BC9E;}
.dep-item-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:3px;}
.dep-item-text{font-size:10.5px;font-weight:500;color:#1C2D5E;line-height:1.4;}
.dep-item-theme{font-size:9px;color:#8A9BB0;margin-top:1px;}
.dep-empty{font-size:10px;color:#C8BC9E;font-style:italic;padding:4px 0;}

/* HINT */
.hint{
  position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
  font-size:10px;font-weight:500;letter-spacing:.12em;text-transform:uppercase;
  color:#8A9BB0;display:flex;align-items:center;gap:8px;
  transition:opacity .3s;white-space:nowrap;pointer-events:none;
}
.hint.hidden{opacity:0;}
.hint-dot{width:6px;height:6px;border-radius:50%;background:#E07B30;animation:blink 2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}

.reset-btn{
  position:absolute;top:16px;right:16px;
  font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;
  color:#8A9BB0;background:none;border:1px solid #e0d8cc;border-radius:20px;
  padding:5px 12px;cursor:pointer;transition:all .2s;
  opacity:0;pointer-events:none;
}
.reset-btn.visible{opacity:1;pointer-events:all;}
.reset-btn:hover{color:#1C2D5E;border-color:#C8BC9E;}

/* ── MAP VIEW ── */
#map-view iframe{width:100%;height:100%;border:none;}
</style>
</head>
<body>

<nav class="top-nav">
  <div class="nav-brand">AI Readiness Framework</div>
  <div class="nav-tabs">
    <button class="nav-tab active" id="tab-octagon" onclick="switchView('octagon')">
      <span class="nav-tab-dot" style="background:#1C2D5E;"></span>
      Framework Overview
    </button>
    <button class="nav-tab" id="tab-map" onclick="switchView('map')">
      <span class="nav-tab-dot" style="background:#E07B30;"></span>
      Use Case Explorer
    </button>
  </div>
</nav>

<div class="view-container">

  <!-- OCTAGON VIEW -->
  <div class="view active" id="octagon-view">

    <!-- Left: Theme Sidebar -->
    <div class="theme-sidebar" id="themeSidebar">
      <div class="sidebar-label">Themes</div>
    </div>

    <!-- Centre: Octagon -->
    <div class="octagon-centre" id="octagonCentre">
      <button class="reset-btn" id="resetBtn" onclick="resetAll()">✕ Reset</button>
      <svg id="octagon-svg" style="position:relative;z-index:5;"></svg>
      <div class="hint" id="hint">
        <div class="hint-dot"></div>
        Click a theme or use case to explore dependencies
      </div>
    </div>

    <!-- Right: Dependency Panel -->
    <div class="dep-panel" id="depPanel">
      <div class="dep-panel-title" id="depTitle"></div>
      <div class="dep-panel-sub" id="depSub"></div>
      <div id="depContent"></div>
    </div>

  </div>

  <!-- MAP VIEW -->
  <div class="view" id="map-view"></div>

</div>

<script>
// ─── DATA ────────────────────────────────────────────────────────────────────
const THEMES = [
  {
    id:'creative', name:'Creative', num:'01', color:'#2563EB',
    useCases:[
      {id:'cr1',level:'FOUNDATION',name:'AI copy & creative generation',
       needs:[],enables:['cr2','cr3','co1']},
      {id:'cr2',level:'GROWTH',name:'Asset localisation at scale',
       needs:['cr1'],enables:['cr3','me1']},
      {id:'cr3',level:'GROWTH',name:'Cultural reactive creative engine',
       needs:['cr1','in2'],enables:['cr4']},
      {id:'cr4',level:'EMBEDDED',name:'Autonomous creative testing loop',
       needs:['cr2','cr3','me3','in1'],enables:[]},
    ]
  },
  {
    id:'audience', name:'Audience', num:'02', color:'#7C3AED',
    useCases:[
      {id:'au1',level:'FOUNDATION',name:'Segmentation & lookalike generation',
       needs:[],enables:['au2','au3','me1']},
      {id:'au2',level:'GROWTH',name:'Dynamic refresh & churn prediction',
       needs:['au1','in1'],enables:['au3','au4','cj3']},
      {id:'au3',level:'GROWTH',name:'Emerging segment detection',
       needs:['au1','in2'],enables:['au4','me3']},
      {id:'au4',level:'EMBEDDED',name:'Autonomous audience orchestration',
       needs:['au2','au3','me2'],enables:['me5','cj4']},
    ]
  },
  {
    id:'content', name:'Content', num:'03', color:'#DB2777',
    useCases:[
      {id:'co1',level:'FOUNDATION',name:'AI-assisted creation & editing',
       needs:[],enables:['co2','co3']},
      {id:'co2',level:'GROWTH',name:'Systematic repurposing engine',
       needs:['co1'],enables:['co3','co4']},
      {id:'co3',level:'GROWTH',name:'SEO & content gap intelligence',
       needs:['co1','in2'],enables:['co4']},
      {id:'co4',level:'EMBEDDED',name:'Autonomous content operations loop',
       needs:['co2','co3','in1'],enables:[]},
    ]
  },
  {
    id:'media', name:'Media & Performance', num:'04', color:'#D97706',
    useCases:[
      {id:'me1',level:'FOUNDATION',name:'AI campaign setup & targeting',
       needs:['au1'],enables:['me3','me4']},
      {id:'me2',level:'FOUNDATION',name:'Attribution Model',
       needs:[],enables:['me3','in3','au4']},
      {id:'me3',level:'GROWTH',name:'Real-time bid & budget optimisation',
       needs:['me1','me2'],enables:['me4','me5','cr4']},
      {id:'me4',level:'GROWTH',name:'Dynamic creative optimisation (DCO)',
       needs:['me1','au2'],enables:['me5']},
      {id:'me5',level:'EMBEDDED',name:'Autonomous media agent',
       needs:['me3','me4','au4'],enables:[]},
    ]
  },
  {
    id:'insights', name:'Insights & Intelligence', num:'05', color:'#059669',
    useCases:[
      {id:'in1',level:'FOUNDATION',name:'Automated reporting & dashboards',
       needs:['me2'],enables:['in2','au2','cj1']},
      {id:'in2',level:'FOUNDATION',name:'Competitive & market monitoring',
       needs:[],enables:['in3','cr3','co3','au3']},
      {id:'in3',level:'GROWTH',name:'AI attribution & incrementality',
       needs:['me2','in1'],enables:['in4','me4']},
      {id:'in4',level:'GROWTH',name:'Predictive performance modelling',
       needs:['in1','in3'],enables:['in5','me5']},
      {id:'in5',level:'EMBEDDED',name:'Autonomous insight generation',
       needs:['in3','in4'],enables:['cr4','co4']},
    ]
  },
  {
    id:'journey', name:'Customer Journey', num:'06', color:'#0891B2',
    useCases:[
      {id:'cj1',level:'FOUNDATION',name:'Journey mapping & friction detection',
       needs:['in1'],enables:['cj2','cj3']},
      {id:'cj2',level:'FOUNDATION',name:'Conversational AI & intelligent routing',
       needs:[],enables:['cj3','cj4']},
      {id:'cj3',level:'GROWTH',name:'Real-time personalisation & next best action',
       needs:['cj1','cj2','au2'],enables:['cj4']},
      {id:'cj4',level:'EMBEDDED',name:'Autonomous journey orchestration',
       needs:['cj3','au4'],enables:[]},
    ]
  },
  {
    id:'operations', name:'Operations & Workflow', num:'07', color:'#BE185D',
    useCases:[
      {id:'op1',level:'FOUNDATION',name:'AI-assisted briefing',
       needs:[],enables:['op2','op3','cr1','co1']},
      {id:'op2',level:'FOUNDATION',name:'Prompt library & onboarding kit',
       needs:['op1'],enables:['op3','kl1','kl2']},
      {id:'op3',level:'GROWTH',name:'Campaign intake & scoping',
       needs:['op1','op2'],enables:['op4','op5']},
      {id:'op4',level:'GROWTH',name:'Governance & guardrail design',
       needs:['op3'],enables:['op5','op6','me5','au4']},
      {id:'op5',level:'EMBEDDED',name:'Autonomous anomaly detection & response',
       needs:['op4','in1','me2'],enables:['op6']},
      {id:'op6',level:'EMBEDDED',name:'Listener-driven multi-agent network',
       needs:['op4','op5','kl3'],enables:[]},
    ]
  },
  {
    id:'knowledge', name:'Knowledge & Learning', num:'08', color:'#047857',
    useCases:[
      {id:'kl1',level:'FOUNDATION',name:'AI knowledge base & team assistant',
       needs:[],enables:['kl2','kl3','op2']},
      {id:'kl2',level:'FOUNDATION',name:'AI-accelerated onboarding',
       needs:['kl1'],enables:['kl3']},
      {id:'kl3',level:'GROWTH',name:'Insight capture & institutional memory',
       needs:['kl1','kl2'],enables:['kl4','op6']},
      {id:'kl4',level:'EMBEDDED',name:'Self-updating intelligence layer',
       needs:['kl3','in5'],enables:[]},
    ]
  },
];

// Build fast lookups
const ucById = {};
const themeByUcId = {};
const themeById = {};
THEMES.forEach(t => {
  themeById[t.id] = t;
  t.useCases.forEach(uc => {
    ucById[uc.id] = uc;
    themeByUcId[uc.id] = t;
  });
});

// For a set of UC ids, which theme ids are involved?
function themeIdsForUcIds(ucIds) {
  const s = new Set();
  ucIds.forEach(id => { if(themeByUcId[id]) s.add(themeByUcId[id].id); });
  return s;
}

// ─── SVG OCTAGON BUILD ────────────────────────────────────────────────────────
const SVG_W = 680, SVG_H = 680;
const CX = 340, CY = 340;
const R_IN = 68, R_OUT = 310;
const GAP = 0.022;
const N = 8;
const LEVEL_FRACS = [0.12, 0.37, 0.62, 0.80, 0.92]; // up to 5 UCs per segment; ops has 6

const svg = document.getElementById('octagon-svg');
svg.setAttribute('width', SVG_W);
svg.setAttribute('height', SVG_H);
svg.setAttribute('viewBox', `0 0 ${SVG_W} ${SVG_H}`);

// Defs
const defs = svgEl('defs');
const grad = svgEl('radialGradient',{id:'cg',cx:'50%',cy:'50%',r:'50%'});
grad.innerHTML = `<stop offset="0%" stop-color="#1C2D5E" stop-opacity="0.07"/>
                  <stop offset="100%" stop-color="#1C2D5E" stop-opacity="0"/>`;
defs.appendChild(grad);
svg.appendChild(defs);

// Centre glow
svg.appendChild(svgEl('circle',{cx:CX,cy:CY,r:110,fill:'url(#cg)'}));
svg.appendChild(svgEl('circle',{cx:CX,cy:CY,r:R_IN,fill:'rgba(28,45,94,0.04)',
  stroke:'#1C2D5E','stroke-width':'1','stroke-opacity':'0.15'}));

// Centre label
const centreG = svgEl('g',{'pointer-events':'none'});
const cl1 = svgEl('text',{x:CX,y:CY-10,'text-anchor':'middle','dominant-baseline':'middle',
  fill:'#C8BC9E','font-size':'8','font-weight':'700','letter-spacing':'2','font-family':'Inter,sans-serif'});
cl1.textContent = 'GOAL';
const cl2 = svgEl('text',{x:CX,y:CY+8,'text-anchor':'middle','dominant-baseline':'middle',
  fill:'#1C2D5E','font-size':'13','font-weight':'900','font-family':'Inter,sans-serif'});
cl2.textContent = 'AI Embedded';
centreG.appendChild(cl1); centreG.appendChild(cl2);
svg.appendChild(centreG);

// Segment + UC pill elements
const segElems = {};   // themeId → path
const ucElems  = {};   // ucId    → {pill, label, dot}

THEMES.forEach((theme, i) => {
  const step = Math.PI * 2 / N;
  const mid  = i * step - Math.PI / 2;
  const s    = mid - step/2 + GAP;
  const e    = mid + step/2 - GAP;

  // Segment path
  const d = arcPath(s, e, R_IN, R_OUT);
  const path = svgEl('path',{
    d, fill:hexAlpha(theme.color,.07),
    stroke:theme.color,'stroke-width':'1.2','stroke-opacity':'0.4',
    cursor:'pointer',
    'data-theme':theme.id,
  });
  path.style.transition = 'all .2s';
  path.addEventListener('click', e => { e.stopPropagation(); handleThemeClick(theme.id); });
  svg.appendChild(path);
  segElems[theme.id] = path;

  // Sub-arc lines (maturity rings)
  [0.33, 0.66].forEach(f => {
    const r = R_IN + (R_OUT-R_IN)*f;
    const arc = svgEl('path',{
      d:`M ${CX+Math.cos(s+.01)*r} ${CY+Math.sin(s+.01)*r} A ${r} ${r} 0 0 1 ${CX+Math.cos(e-.01)*r} ${CY+Math.sin(e-.01)*r}`,
      fill:'none',stroke:theme.color,'stroke-width':'0.5','stroke-opacity':'0.18','pointer-events':'none'
    });
    svg.appendChild(arc);
  });

  // Theme label
  const lblR = R_IN + (R_OUT-R_IN)*0.90;
  const lx   = CX + Math.cos(mid)*lblR;
  const ly   = CY + Math.sin(mid)*lblR;
  const lblG = svgEl('g',{'pointer-events':'none'});
  const lbl  = svgEl('text',{
    x:lx, y:ly,
    'text-anchor':'middle','dominant-baseline':'middle',
    fill:theme.color,'font-size':'9.5','font-weight':'800',
    'letter-spacing':'0.5','font-family':'Inter,sans-serif',
  });
  // Rotate label to follow arc
  const rot = (mid * 180/Math.PI) + 90 + ([3,4,5,6].includes(i) ? 180 : 0);
  lbl.setAttribute('transform', `rotate(${rot},${lx},${ly})`);
  lbl.textContent = theme.name.toUpperCase();
  lblG.appendChild(lbl);
  svg.appendChild(lblG);

  // UC Pills — adapt fracs to count
  const ucs = theme.useCases;
  const fracs = ucFracs(ucs.length);
  const isLeft = [3,4,5,6].includes(i);

  ucs.forEach((uc, ni) => {
    const r    = R_IN + (R_OUT-R_IN)*fracs[ni];
    const ux   = CX + Math.cos(mid)*r;
    const uy   = CY + Math.sin(mid)*r;
    const arcSpan = r * (e - s) * 0.72;
    const pillH   = 15;

    const ucG = svgEl('g',{cursor:'pointer','data-uc':uc.id});
    const rot2 = (mid * 180/Math.PI) + 90 + (isLeft ? 180 : 0);
    ucG.setAttribute('transform', `translate(${ux},${uy}) rotate(${rot2})`);

    // Pill bg
    const pill = svgEl('rect',{
      x:-arcSpan/2, y:-pillH/2,
      width:arcSpan, height:pillH, rx:'4',
      fill:hexAlpha(theme.color,.10),
      stroke:theme.color,'stroke-width':'0.7','stroke-opacity':'0.35',
    });
    pill.style.transition='all .2s';

    // Level dot
    const dotCol = uc.level==='FOUNDATION'?'#1C2D5E':uc.level==='GROWTH'?'#E07B30':'#6B3FA0';
    const dot = svgEl('circle',{cx:-arcSpan/2+9,cy:0,r:3.5,fill:dotCol,'fill-opacity':'0.85'});

    // Label text
    const txt = svgEl('text',{
      x:-arcSpan/2+18, y:0,
      'dominant-baseline':'middle',
      fill:'#1C2D5E','font-size':'8','font-weight':'600','font-family':'Inter,sans-serif',
    });
    txt.textContent = truncate(uc.name, arcSpan-24, 8);
    txt.style.transition='opacity .2s';

    ucG.appendChild(pill);
    ucG.appendChild(dot);
    ucG.appendChild(txt);
    ucG.addEventListener('click', ev => { ev.stopPropagation(); handleUcClick(uc.id); });
    svg.appendChild(ucG);

    ucElems[uc.id] = {g:ucG, pill, dot, txt};
  });
});

// ─── SIDEBAR BUILD ────────────────────────────────────────────────────────────
const sidebar = document.getElementById('themeSidebar');
THEMES.forEach(theme => {
  const btn = document.createElement('button');
  btn.className = 'sidebar-theme-btn';
  btn.id = `sb-${theme.id}`;
  btn.innerHTML = `<span class="sidebar-num">•</span><span class="sidebar-name">${theme.name}</span>`;
  btn.addEventListener('click', () => handleThemeSidebarClick(theme.id));
  sidebar.appendChild(btn);
});

// ─── INTERACTION ──────────────────────────────────────────────────────────────
let activeId   = null;   // uc or theme id
let activeType = null;   // 'uc' | 'theme'

function handleThemeSidebarClick(themeId) {
  // Navigate to dependency map and open that theme
  switchView('map', themeId);
}

function handleThemeClick(themeId) {
  if(activeType==='theme' && activeId===themeId){ resetAll(); return; }
  activeId   = themeId;
  activeType = 'theme';

  const theme = themeById[themeId];

  // Collect all uc-level deps across this theme
  const allNeeds   = new Set();
  const allEnables = new Set();
  theme.useCases.forEach(uc => {
    uc.needs.forEach(id   => allNeeds.add(id));
    uc.enables.forEach(id => allEnables.add(id));
  });

  // Which themes are involved (excluding self)
  const needThemes    = themeIdsForUcIds([...allNeeds]);
  const enableThemes  = themeIdsForUcIds([...allEnables]);
  needThemes.delete(themeId);
  enableThemes.delete(themeId);

  styleSegments(themeId, needThemes, enableThemes, new Set());
  styleSidebar(themeId, needThemes, enableThemes);
  styleUcs(null, new Set(), new Set()); // no UC-level highlight on theme click

  // Panel
  showPanel(
    theme.name,
    'THEME · Click a use case for detail',
    [...needThemes].map(tid => ({id:tid, type:'theme',
      label:themeById[tid].name, sub:'Theme dependency', color:themeById[tid].color})),
    [...enableThemes].map(tid => ({id:tid, type:'theme',
      label:themeById[tid].name, sub:'Unlocked theme', color:themeById[tid].color})),
  );

  showControls();
}

function handleUcClick(ucId) {
  if(activeType==='uc' && activeId===ucId){ resetAll(); return; }
  activeId   = ucId;
  activeType = 'uc';

  const uc        = ucById[ucId];
  const myTheme   = themeByUcId[ucId];
  const needIds   = new Set(uc.needs);
  const enableIds = new Set(uc.enables);

  // Theme-level: which themes own these UCs
  const needThemes   = themeIdsForUcIds([...needIds]);
  const enableThemes = themeIdsForUcIds([...enableIds]);

  styleSegments(myTheme.id, needThemes, enableThemes, new Set());
  styleSidebar(myTheme.id, needThemes, enableThemes);
  styleUcs(ucId, needIds, enableIds);

  // Panel
  const needItems   = [...needIds].map(id => ({
    id, type:'uc',
    label:ucById[id].name,
    sub:themeByUcId[id].name,
    color:themeByUcId[id].color,
  }));
  const enableItems = [...enableIds].map(id => ({
    id, type:'uc',
    label:ucById[id].name,
    sub:themeByUcId[id].name,
    color:themeByUcId[id].color,
  }));

  const levelBadge = {FOUNDATION:'navy',GROWTH:'orange',EMBEDDED:'purple'}[uc.level];
  showPanel(uc.name, `${uc.level} · ${myTheme.name}`, needItems, enableItems);
  showControls();
}

function styleSegments(activeThemeId, needThemes, enableThemes, dimExtra) {
  THEMES.forEach(t => {
    const el = segElems[t.id];
    if(t.id === activeThemeId){
      el.setAttribute('fill', hexAlpha(t.color,.22));
      el.setAttribute('stroke', t.color);
      el.setAttribute('stroke-width','2.5');
      el.setAttribute('stroke-opacity','1');
    } else if(needThemes.has(t.id)){
      el.setAttribute('fill', hexAlpha('#E07B30',.12));
      el.setAttribute('stroke','#E07B30');
      el.setAttribute('stroke-width','2');
      el.setAttribute('stroke-opacity','1');
    } else if(enableThemes.has(t.id)){
      el.setAttribute('fill', hexAlpha('#00A078',.10));
      el.setAttribute('stroke','#00A078');
      el.setAttribute('stroke-width','2');
      el.setAttribute('stroke-opacity','1');
    } else {
      el.setAttribute('fill', hexAlpha(t.color,.03));
      el.setAttribute('stroke', t.color);
      el.setAttribute('stroke-width','0.8');
      el.setAttribute('stroke-opacity','0.15');
    }
  });
}

function styleSidebar(activeThemeId, needThemes, enableThemes) {
  THEMES.forEach(t => {
    const btn = document.getElementById(`sb-${t.id}`);
    btn.className = 'sidebar-theme-btn';
    if(t.id === activeThemeId) btn.classList.add('active');
    else if(needThemes.has(t.id)) btn.classList.add('dep-needs');
    else if(enableThemes.has(t.id)) btn.classList.add('dep-enables');
    else btn.classList.add('dimmed');
  });
}

function styleUcs(activeUcId, needIds, enableIds) {
  THEMES.forEach(theme => {
    theme.useCases.forEach(uc => {
      const el = ucElems[uc.id];
      if(!el) return;
      if(uc.id === activeUcId){
        el.pill.setAttribute('fill', hexAlpha(theme.color,.28));
        el.pill.setAttribute('stroke-width','1.5');
        el.pill.setAttribute('stroke-opacity','1');
        el.txt.setAttribute('fill','#1C2D5E');
        el.g.style.opacity='1';
      } else if(needIds.has(uc.id)){
        el.pill.setAttribute('fill', hexAlpha('#E07B30',.22));
        el.pill.setAttribute('stroke','#E07B30');
        el.pill.setAttribute('stroke-width','1.5');
        el.pill.setAttribute('stroke-opacity','1');
        el.txt.setAttribute('fill','#1C2D5E');
        el.g.style.opacity='1';
      } else if(enableIds.has(uc.id)){
        el.pill.setAttribute('fill', hexAlpha('#00A078',.18));
        el.pill.setAttribute('stroke','#00A078');
        el.pill.setAttribute('stroke-width','1.5');
        el.pill.setAttribute('stroke-opacity','1');
        el.txt.setAttribute('fill','#1C2D5E');
        el.g.style.opacity='1';
      } else if(activeUcId || activeId){
        el.pill.setAttribute('fill', hexAlpha(theme.color,.04));
        el.pill.setAttribute('stroke',theme.color);
        el.pill.setAttribute('stroke-width','0.5');
        el.pill.setAttribute('stroke-opacity','0.15');
        el.txt.setAttribute('fill','#8A9BB0');
        el.g.style.opacity='0.35';
      } else {
        resetUcStyle(uc, theme);
      }
    });
  });
}

function resetUcStyle(uc, theme){
  const el = ucElems[uc.id];
  if(!el) return;
  el.pill.setAttribute('fill', hexAlpha(theme.color,.10));
  el.pill.setAttribute('stroke',theme.color);
  el.pill.setAttribute('stroke-width','0.7');
  el.pill.setAttribute('stroke-opacity','0.35');
  el.txt.setAttribute('fill','#1C2D5E');
  el.g.style.opacity='1';
}

function showPanel(title, sub, needItems, enableItems){
  document.getElementById('depTitle').textContent = title;
  document.getElementById('depSub').textContent   = sub;

  let html = '';
  if(needItems.length){
    html += `<div class="dep-group">
      <div class="dep-group-label needs">Needs first (${needItems.length})</div>`;
    needItems.forEach(item => {
      html += `<div class="dep-item" onclick="handleItemClick('${item.id}','${item.type}')">
        <div class="dep-item-dot" style="background:${item.color}"></div>
        <div><div class="dep-item-text">${item.label}</div>
        <div class="dep-item-theme">${item.sub}</div></div>
      </div>`;
    });
    html += `</div>`;
  }
  if(enableItems.length){
    html += `<div class="dep-group">
      <div class="dep-group-label enables">Unlocks (${enableItems.length})</div>`;
    enableItems.forEach(item => {
      html += `<div class="dep-item" onclick="handleItemClick('${item.id}','${item.type}')">
        <div class="dep-item-dot" style="background:${item.color}"></div>
        <div><div class="dep-item-text">${item.label}</div>
        <div class="dep-item-theme">${item.sub}</div></div>
      </div>`;
    });
    html += `</div>`;
  }
  if(!needItems.length && !enableItems.length){
    html = `<div class="dep-empty">No cross-theme dependencies</div>`;
  }

  document.getElementById('depContent').innerHTML = html;
  document.getElementById('depPanel').classList.add('visible');
}

function handleItemClick(id, type){
  if(type==='uc') handleUcClick(id);
  else handleThemeClick(id);
}

function showControls(){
  document.getElementById('hint').classList.add('hidden');
  document.getElementById('resetBtn').classList.add('visible');
}

function resetAll(){
  activeId=null; activeType=null;
  document.getElementById('hint').classList.remove('hidden');
  document.getElementById('resetBtn').classList.remove('visible');
  document.getElementById('depPanel').classList.remove('visible');
  THEMES.forEach(t => {
    const el = segElems[t.id];
    el.setAttribute('fill', hexAlpha(t.color,.07));
    el.setAttribute('stroke',t.color);
    el.setAttribute('stroke-width','1.2');
    el.setAttribute('stroke-opacity','0.4');
    const btn = document.getElementById(`sb-${t.id}`);
    btn.className = 'sidebar-theme-btn';
    t.useCases.forEach(uc => resetUcStyle(uc, t));
  });
}

// Click outside to reset
document.getElementById('octagonCentre').addEventListener('click', resetAll);

// ─── HELPERS ─────────────────────────────────────────────────────────────────
function arcPath(s, e, rIn, rOut){
  const cx=CX,cy=CY,c=Math.cos,sn=Math.sin;
  return [
    `M ${cx+c(s)*rIn}  ${cy+sn(s)*rIn}`,
    `A ${rIn}  ${rIn}  0 0 1 ${cx+c(e)*rIn}  ${cy+sn(e)*rIn}`,
    `L ${cx+c(e)*rOut} ${cy+sn(e)*rOut}`,
    `A ${rOut} ${rOut} 0 0 0 ${cx+c(s)*rOut} ${cy+sn(s)*rOut}`,
    `Z`
  ].join(' ');
}

function svgEl(tag, attrs={}){
  const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
  Object.entries(attrs).forEach(([k,v]) => el.setAttribute(k,v));
  return el;
}

function hexAlpha(hex, a){
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${a})`;
}

function ucFracs(n){
  // Evenly space n UCs between R_IN and the label band
  const fracs=[];
  const lo=0.08, hi=0.78;
  for(let i=0;i<n;i++) fracs.push(lo + (hi-lo)*(n===1?0.5:i/(n-1)));
  return fracs;
}

function truncate(str, maxPx, fontSize){
  // Rough char-width estimate: fontSize * 0.55
  const charW = fontSize * 0.56;
  const maxChars = Math.floor(maxPx / charW);
  return str.length <= maxChars ? str : str.slice(0, maxChars-1)+'…';
}

// ─── VIEW SWITCHING ──────────────────────────────────────────────────────────
let mapLoaded = false;
let pendingTheme = null;

function switchView(view, themeId){
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));

  if(view==='octagon'){
    document.getElementById('tab-octagon').classList.add('active');
    document.getElementById('octagon-view').classList.add('active');
  } else {
    document.getElementById('tab-map').classList.add('active');
    document.getElementById('map-view').classList.add('active');
    if(!mapLoaded){
      const iframe = document.createElement('iframe');
      iframe.src = 'dependency-map.html';
      iframe.title = 'AI Use Case Explorer';
      iframe.id = 'map-iframe';
      document.getElementById('map-view').appendChild(iframe);
      mapLoaded = true;
      if(themeId){
        iframe.addEventListener('load', () => {
          iframe.contentWindow.postMessage({type:'showTheme',themeId}, '*');
        });
      }
    } else if(themeId){
      const iframe = document.getElementById('map-iframe');
      if(iframe) iframe.contentWindow.postMessage({type:'showTheme',themeId},'*');
    }
  }
}

// ─── RESPONSIVE SCALE ────────────────────────────────────────────────────────
function scaleOctagon(){
  const centre = document.getElementById('octagonCentre');
  const avW = centre.clientWidth  - 40;
  const avH = centre.clientHeight - 40;
  const scale = Math.min(avW/SVG_W, avH/SVG_H, 1);
  svg.style.transform = `scale(${scale})`;
  svg.style.transformOrigin = 'center center';
}
window.addEventListener('resize', scaleOctagon);
setTimeout(scaleOctagon, 50);
</script>
</body>
</html>
